# https://docs.github.com/en/actions/learn-github-actions/expressions
name: CI
on:
  push:
    branches: 'main'
  pull_request:
    branches: 'main'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@v3
    - name: install utilities
      run: sudo apt install w3m
    - name: pull docker images
      run: make images
    - name: xqerl up and flying
      run: make up
    - name: add example.com to '/etc/hosts' file
      run: make hosts
    - name: check domain name resolution
      run: w3m -dump http://example.com:8080
    - name: build - data as XDM items into xqerl-database volume
      run: make data
    - name: build - xQuery library modules into  xqerl-code volume
      run: make code
    - name: build - static assets into static assets volume
      run: make assets
    - name: build - nginx configuration into proxy-conf volume
      run: make confs
    - name: check - web view
      run: w3m -dump http://example.com:8080
    - name:  check - deploy dir
      run: ls -al _deploy
    - name: bring xqerl down
      run: make down
    - name: Upload built artifact
      uses: actions/upload-artifact@v3
      with:
        name: volume-tars
        path: _deploy/
    - name: TODO
      run: |
        echo 'export _deploy, the import volume in _deploy in another job, check result'
  check:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@v3
    - name: Download built artifact
      uses: actions/download-artifact@v3
      with:
        name: volume-tars
    - name: pull docker images
      run: make images
    - name: import tars
      run: |
        podman create volume proxy-conf
        podman volume import proxy-conf proxy-conf.tar
        podman create volume static-assets
        podman volume import static-assets static-assets.tar
        podman create volume xqerl-database
        podman volume import xqerl-database xqerl-database.tar
        podman create volume xqerl-code
        podman volume import xqerl-code xqerl-code.tar

