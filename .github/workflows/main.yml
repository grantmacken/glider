# https://docs.github.com/en/actions/learn-github-actions/expressions
name: CI
on:
  push:
    branches: 'main'
  pull_request:
    branches: 'main'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repo
      uses: actions/checkout@v3
    - name: podman info
      run: |
        podman version
    - name: xqerl up and flying
      run: make up
    - name: checks - ps, log, top
      run: |
        podman ps --pod --all
        printf %60s | tr ' ' '-' && echo
        podman logs xq | grep -oP "started_at: 'xqerl@127.0.0.1'"
        printf %60s | tr ' ' '-' && echo
        podman top xq
    - name: add example.com to '/etc/hosts' file
      run: make hosts
    - name: build website from souces
      run: make
    - name: check - installed xQuery library modules
      run: make code-library-list
    - name: check - XDM items in xqerl database
      run: make data-domain-list
    - name: check - w3m browser dump
      run: make dump
    - name: bring xqerl down
      run: make down
    #   run: make down

    # - name: build - data as XDM items into xqerl-database volume
    #   run: make data-domain-list
    # - name: build - xQuery library modules into  xqerl-code volume
    #   run: make code
    # - name: build - static assets into static assets volume
    #   run: make assets
    # - name: build - nginx configuration into proxy-conf volume
    #   run: make confs
    # - name: check result
    #   run: make dump
    # - name:  check - deploy dir
    #   run: ls -al _deploy
    # - name: bring pod down
    #   run: make down
    # - name: bring pod up
    #   run: make up
    # - name: xqerl-database Volume check - db has items
    #   run: make data-domain-list
    # - name: xqerl-code Volume check -  listed library modules
    #   run: make code-library-list
    # - name: restXQ routing check
    #   run: make dump 
