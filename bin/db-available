#!/usr/bin/env bash
set -Eeuo pipefail
declare -a args
args=("$@")
RED='\033[0;31m'
NC='\033[0m' # No Color
source .env

function dash {
  printf %60s | tr ' ' '-' && echo
}

function msg() {
  echo >&2 -e "${1-}"
}

function die() {
  local msg=$(echo -n " ${RED}âœ˜${NC} " && echo $1)
  local code=${2-1} # default exit status 1
  msg "$msg"
  exit "$code"
}

case "${#args[@]}" in
1)
  BASE=$(echo $1 | grep -oP '^(src/data/)?\K(.+)$')
  SRC="src/data/$BASE"
  # [ -f $SRC ] || die "[ $SRC ]: NOT a file "
  DIRNAME=$(dirname $BASE)
  BASENAME=$(basename $BASE)
  EXT="${BASENAME##*.}"
  RESOURCE="${BASENAME%.*}"
  DB='http://localhost:8081/db'
  URI="${DB}/${DIRNAME}/${RESOURCE}"
  #echo "##[ available:  $BASE ]##"
  # echo "##[ avaialable:  $URI ]##"
  # use extension
  case ${EXT} in
  csv)
    ${CRL}
  ;;
  json)
    podman run --rm --pod podx ghcr.io/grantmacken/podx-curl:${CURL_VER} \
		--silent --show-error --connect-timeout 1 --max-time 2 \
		--write-out '%{http_code}' --output /dev/null \
		-I --header "Accept: application/json" \
		$URI | grep -q '200'
  ;;
  xml)
     podman run --rm --pod podx ghcr.io/grantmacken/podx-curl:${CURL_VER} \
		--silent --show-error --connect-timeout 1 --max-time 2 \
		--write-out '%{http_code}' --output /dev/null \
		-I --header "Accept: application/xml" \
		$URI | grep -q '200'
  ;;
  md)
     podman run --rm --pod podx ghcr.io/grantmacken/podx-curl:${CURL_VER} \
		--silent --show-error --connect-timeout 1 --max-time 2 \
		--write-out '%{http_code}' --output /dev/null \
		-I --header "Accept: application/xml" \
		$URI | grep -q '200'
  ;;
  csv)
     podman run --rm --pod podx ghcr.io/grantmacken/podx-curl:${CURL_VER} \
		--silent --show-error --connect-timeout 1 --max-time 2 \
		--write-out '%{http_code}' --output /dev/null \
		-I --header "Accept: application/json" \
		$URI
  ;;

  xq)
    dash
    echo 'TODO'
  ;;
  *)
    die " [ ${EXT} ] can not handle extension "
    ;;
  esac
  ;;
*)
  die "Usage: $(basename "${BASH_SOURCE[0]}") [src] 1 arg required"
  ;;
esac

