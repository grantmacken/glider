define todo_restXQ
module namespace _ = 'http://$(DOMAIN)/#routes';
declare
  %rest:path("/$(DOMAIN)/items/new")
  %rest:GET
  %rest:produces("text/html")
  %output:method("html")
function _:items($$ITEM){
  try {
  let $$uri := 'http://$(DOMAIN)/' || $$ITEM
  let $$resMap := 
      map{'uri': $$uri, 
          'domain': '$(DOMAIN)',
          'collection' : _:dbCollection($$uri), 
          'item':  _:dbItem($$uri)}
  return
    if ( fn:doc-available( $$uri  )) 
    then
      let $$key := 'document'
      let $$value := $$uri => doc()
      return
        map:put($$resMap ,$$key, $$value) =>
        _:getContent() =>
        _:getFrontMatter() => 
        _:pageLayout()
    else _:notFound($$resMap) 
  } catch * {(
    _:svrErr(
		map { 'uri': 'http://' || '$(DOMAIN)/' || $$ITEM,
             'problem' : 'xQuery dynamic error',
             'code' : $$err:code, 
             'description' : $$err:description
             } 
      )
   )}
};
endef

